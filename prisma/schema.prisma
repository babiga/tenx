// Tenx Catering Platform - Prisma Schema
// Separated User (customers) and DashboardUser (chefs, companies, admins)

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserType {
  INDIVIDUAL
  CORPORATE
}

enum DashboardUserRole {
  ADMIN
  CHEF
  COMPANY
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ServiceType {
  CORPORATE
  PRIVATE
  WEDDING
  VIP
}

enum BookingStatus {
  PENDING
  CONFIRMED
  DEPOSIT_PAID
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum EventType {
  WEDDING
  CORPORATE
  PRIVATE
  SOCIAL
}

enum ContractStatus {
  DRAFT
  SENT
  SIGNED
  COMPLETED
  CANCELLED
}

enum PaymentMethod {
  QPAY
  BANK_TRANSFER
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum MembershipType {
  ANNUAL
}

enum MembershipStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum JobStatus {
  OPEN
  ASSIGNED
  COMPLETED
  CANCELLED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum TransactionType {
  EARNING
  PAYOUT
  MEMBERSHIP_FEE
  REFUND
}

enum NotificationType {
  EMAIL
  PUSH
  IN_APP
}

// ============================================
// USER (Customers - Public Website)
// ============================================

model User {
  id               String   @id @default(cuid())
  email            String   @unique
  name             String
  firstName        String?
  lastName         String?
  phone            String?
  address          String?
  userType         UserType @default(INDIVIDUAL)
  organizationName String?
  companyLegalNo   String?
  googleId         String?  @unique
  avatar           String?
  password         String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  bookings      Booking[]
  reviews       Review[]
  notifications Notification[]
}

// ============================================
// DASHBOARD USER (Chefs, Companies, Admins)
// ============================================

model DashboardUser {
  id          String            @id @default(cuid())
  email       String            @unique
  password    String
  name        String
  phone       String?
  avatar      String?
  role        DashboardUserRole
  isVerified  Boolean           @default(false)
  isActive    Boolean           @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  chefProfile    ChefProfile?
  companyProfile CompanyProfile?
  jobPostings    JobPosting[]
  jobInvitations JobInvitation[]
  notifications  DashboardNotification[]
}

// ============================================
// PROFILE TABLES
// ============================================

model ChefProfile {
  id              String        @id @default(cuid())
  dashboardUserId String        @unique
  dashboardUser   DashboardUser @relation(fields: [dashboardUserId], references: [id], onDelete: Cascade)

  specialty       String
  bio             String?  @db.Text
  yearsExperience Int      @default(0)
  certifications  String[]
  rating          Float    @default(0)
  reviewCount     Int      @default(0)
  hourlyRate      Decimal  @db.Decimal(10, 2)

  bookings        Booking[]
  reviews         Review[]
  portfolioEvents Event[]
  membership      Membership?
  transactions    TransactionHistory[]
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
}

model CompanyProfile {
  id              String        @id @default(cuid())
  dashboardUserId String        @unique
  dashboardUser   DashboardUser @relation(fields: [dashboardUserId], references: [id], onDelete: Cascade)

  companyName     String
  description     String?        @db.Text
  services        String[]
  portfolioImages String[]
  approvalStatus  ApprovalStatus @default(PENDING)
  approvedAt      DateTime?

  portfolioEvents Event[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================
// SERVICE & MENU TABLES
// ============================================

model ServiceTier {
  id            String   @id @default(cuid())
  name          String   @unique
  description   String?  @db.Text
  pricePerGuest Decimal  @db.Decimal(10, 2)
  features      String[]
  isVIP         Boolean  @default(false)
  sortOrder     Int      @default(0)

  menus     Menu[]
  bookings  Booking[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Menu {
  id            String      @id @default(cuid())
  name          String
  description   String?     @db.Text
  serviceTierId String
  serviceTier   ServiceTier @relation(fields: [serviceTierId], references: [id])
  downloadUrl   String?
  isActive      Boolean     @default(true)

  items     MenuItem[]
  bookings  Booking[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model MenuItem {
  id     String @id @default(cuid())
  menuId String
  menu   Menu   @relation(fields: [menuId], references: [id], onDelete: Cascade)

  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  ingredients String[]
  allergens   String[]
  imageUrl    String?
  sortOrder   Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// BOOKING & EVENTS
// ============================================

model Booking {
  id            String @id @default(cuid())
  bookingNumber String @unique @default(cuid())

  customerId String
  customer   User   @relation(fields: [customerId], references: [id])

  chefProfileId String?
  chefProfile   ChefProfile? @relation(fields: [chefProfileId], references: [id])

  serviceTierId String
  serviceTier   ServiceTier @relation(fields: [serviceTierId], references: [id])

  menuId String?
  menu   Menu?   @relation(fields: [menuId], references: [id])

  serviceType     ServiceType
  eventDate       DateTime
  eventTime       String
  guestCount      Int
  venue           String
  venueAddress    String?
  specialRequests String?     @db.Text

  status        BookingStatus @default(PENDING)
  totalPrice    Decimal       @db.Decimal(12, 2)
  depositAmount Decimal?      @db.Decimal(12, 2)

  contract Contract?
  payments Payment[]
  reviews  Review[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Event {
  id          String    @id @default(cuid())
  title       String
  description String?   @db.Text
  eventType   EventType
  guestCount  Int
  images      String[]
  eventDate   DateTime?

  chefProfileId String?
  chefProfile   ChefProfile? @relation(fields: [chefProfileId], references: [id])

  companyProfileId String?
  companyProfile   CompanyProfile? @relation(fields: [companyProfileId], references: [id])

  isFeatured Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// ============================================
// CONTRACT & PAYMENT
// ============================================

model Contract {
  id        String  @id @default(cuid())
  bookingId String  @unique
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  status       ContractStatus @default(DRAFT)
  termsContent String         @db.Text
  signatureUrl String?
  signedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Payment {
  id        String  @id @default(cuid())
  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  amount Decimal       @db.Decimal(12, 2)
  method PaymentMethod
  status PaymentStatus @default(PENDING)

  // QPay fields
  qpayInvoiceId String?
  qpayQrImage   String?
  qpayDeeplinks Json?

  // Bank transfer fields
  bankName      String?
  accountNumber String?
  transferRef   String?

  transactionId String?
  paidAt        DateTime?

  invoice Invoice?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invoice {
  id        String  @id @default(cuid())
  paymentId String  @unique
  payment   Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  invoiceNumber String  @unique
  items         Json
  subtotal      Decimal @db.Decimal(12, 2)
  tax           Decimal @db.Decimal(12, 2)
  total         Decimal @db.Decimal(12, 2)

  dueDate  DateTime?
  issuedAt DateTime  @default(now())
  paidAt   DateTime?
  pdfUrl   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// REVIEWS & MEMBERSHIP
// ============================================

model Review {
  id        String  @id @default(cuid())
  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  customerId String
  customer   User   @relation(fields: [customerId], references: [id])

  chefProfileId String
  chefProfile   ChefProfile @relation(fields: [chefProfileId], references: [id])

  rating  Int
  title   String?
  comment String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([bookingId, customerId])
}

model Membership {
  id            String      @id @default(cuid())
  chefProfileId String      @unique
  chefProfile   ChefProfile @relation(fields: [chefProfileId], references: [id], onDelete: Cascade)

  type       MembershipType   @default(ANNUAL)
  price      Decimal          @db.Decimal(10, 2)
  startDate  DateTime
  expiryDate DateTime
  status     MembershipStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// ADMIN FEATURES
// ============================================

model JobPosting {
  id          String        @id @default(cuid())
  createdById String
  createdBy   DashboardUser @relation(fields: [createdById], references: [id])

  title       String
  description String    @db.Text
  eventType   EventType
  eventDate   DateTime
  eventTime   String
  guestCount  Int
  venue       String
  budget      Decimal   @db.Decimal(12, 2)
  status      JobStatus @default(OPEN)

  invitations JobInvitation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model JobInvitation {
  id           String     @id @default(cuid())
  jobPostingId String
  jobPosting   JobPosting @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)

  chefId String
  chef   DashboardUser @relation(fields: [chefId], references: [id])

  status      InvitationStatus @default(PENDING)
  invitedAt   DateTime         @default(now())
  respondedAt DateTime?

  @@unique([jobPostingId, chefId])
}

model TransactionHistory {
  id            String      @id @default(cuid())
  chefProfileId String
  chefProfile   ChefProfile @relation(fields: [chefProfileId], references: [id], onDelete: Cascade)

  type             TransactionType
  amount           Decimal         @db.Decimal(12, 2)
  description      String
  relatedBookingId String?

  createdAt DateTime @default(now())
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type    NotificationType
  title   String
  message String
  data    Json?
  isRead  Boolean          @default(false)

  createdAt DateTime @default(now())
}

model DashboardNotification {
  id              String        @id @default(cuid())
  dashboardUserId String
  dashboardUser   DashboardUser @relation(fields: [dashboardUserId], references: [id], onDelete: Cascade)

  type    NotificationType
  title   String
  message String
  data    Json?
  isRead  Boolean          @default(false)

  createdAt DateTime @default(now())
}
